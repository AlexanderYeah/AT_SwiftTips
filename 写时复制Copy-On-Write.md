## 写时复制 Copy-On-Write

#### 1 定义

 在siwft 标准库中，Array，Dictionary，Set这样的集合类型是通过写时复制来实现的。

```swift
import Foundation

var a1 = [1,2,3];
var a2 = a1;

// 将a1 复制给 a2，地址打印结果是相同的

// 0x1--0x2--0x3
print(String(format: "%p--%p--%p", a1[0],a1[1],a1[2]));
// 0x1--0x2--0x3
print(String(format: "%p--%p--%p", a2[0],a2[1],a2[2]));


// 改变a2 中的元素值之后进行打印输出,则两个数组中的元素的内存地址发生变化
a2[2] = 10;
a2[1] = 5;

// 0x1--0x2--0x3
print(String(format: "%p--%p--%p", a1[0],a1[1],a1[2]));
// 0x1--0x5--0xa
print(String(format: "%p--%p--%p", a2[0],a2[1],a2[2]));

```

在Array 结构体含有指向某个内存的引用，这个内存就是数组中元素存储的位置，两个数组的引用指向的是内存的同一个位置。

当我们改变一个数组中的元素的时候，这个时候，才会发生复制，这种元素复制操作只会在必要的时候发生，就是改变元素变量的时候发生。



#### 2 原理

工作方式为每每当数组被改变的时候，它首先会对存储缓冲区的引用是否是唯一的进行检查操作。如果该数组唯一拥有这个存储缓冲区，进行原地变更。

如果不是的话，数组就要先进行复制操作，然后对复制者进行改变，不影响其他持有者。